{% set srcSchName = node.location.name %}
{% set db = storageLocations | selectattr('name', 'equalto', srcSchName) | map(attribute='database') | first %}
{% set sch = storageLocations | selectattr('name', 'equalto', srcSchName) | map(attribute='schema') | first %}

{%- if config.partitionBy | length > 0 %} 
    {% set partitionBySQL = 'PARTITION BY = (' + config.partitionBy + ')' %} 
{%- else -%}
    {% set partitionBySQL = "" %} 
{% endif %}

{% for source in sources %}
    {% for dep in source.dependencies if dep.node %}
        {{ stage('Unloading ' + dep.node.name | string ) }}
        COPY INTO @{{ ref_no_link(node.location.name, config.fileLocation) | trim | upper ~ "/" ~ node.name }}{% if config.singleFile %}.{{ config.fileType | lower }}{% endif %}
        FROM {{ ref_no_link(dep.node.location.name, dep.node.name) | upper }}
        {{ partitionBySQL }}
        FILE_FORMAT = (FORMAT_NAME = '{{ db }}.{{ sch }}.{{ config.fileFormatName}}')
        overwrite = {{ config.overwriteFiles }}
        single = {{ config.singleFile }}
        max_file_size = {{ config.sizeLimit | int * 1024 * 1024 }} 
        include_query_id = {{ config.queryId }}
        detailed_output = {{ config.detailedOutput }}
    {% endfor %}
{% endfor %}

{{ stage('Finished Unloading') }}
select 1